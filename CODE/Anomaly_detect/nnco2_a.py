import tensorflow as tf
import pandas as pd
import numpy as np
from sklearn.preprocessing import LabelBinarizer
from sklearn.model_selection import train_test_split
from keras.models import Sequential
from keras.layers import Dense
from keras.optimizers import SGD,Adam

import os.path
import json
from keras.models import model_from_json
global model
global k
global err
global model
global X_test
global y_pred
global y_pred_class
 
    
k=0
err = []

global Pas,press,temp,humid  #new variables

def loadmodel():
    global model
    
    # Model reconstruction from JSON file
    json_file = open('mlp_arch_2019_22.json', 'r')
    loaded_model_json = json_file.read()
    
    json_file.close()
    model = model_from_json(loaded_model_json)
    model.load_weights('mlp_weights_22.h5')
    model.compile(Adam(lr=0.001),'categorical_crossentropy',metrics=['accuracy'])

    print('model loaded')

loadmodel()



def Control(Class, Setpoint, avgco2):
    global k
    global ErP
    global C1, C2, C3, C4, C5, C6
    global dC1, dC2, dC3, dC4, dC5, dC6 #added addditional global variables
    global vef
    global initial,final
    global err
    global cf
    global cs
    global SetPoint
  
    
    if (Class == 1):
        kp = -0.007
       # kd = -0.00016
        kd=0
        ki = -0.000009

        ErCR = SetPoint - avgco2
        err.append(ErCR)

        P = kp * ErCR
        I = ki * sum(err)
        CS = P + I

        if(CS > 1):
            CS = 1
        if (CS < 0.2):
            CS = 0.2
        ratio = 0.5
    if (Class == 2):
        ratio = 0.3
        CS = 1
    if (Class == 3):
        ratio= 0.7
        CS= 1
    if (Class == 4):
        ratio = 0.4
        CS = 1
    if (Class == 0):
        ratio = 0.5
        CS = 1
        
    return CS, ratio
   


 
def predict(co1,dz1,co2,co3,co4,co5,co6,temp,press,humid,pas):

#def predict(co1,dz1,co2,dz2,co3,dz3,co4,dz4,co5,dz5,co6,dz6,temp,press,humid,pas):
#def predict(a,da,b,db,c,dc,d,dd,e,de,f,df,g,h,i,j):

    control_flag = 0
    avgco2 = (co1 + co2 + co3 + co4 + co5 + co6)/6
    setpoint = 310 + (9*pas)
                 
    meanz=1457.702637595667
    sdz=1141.2473423740623
    meandz=0.0638638733267413
    sddz=2.142768311895675
    
    a=((co1-1457.7026375956484)/1141.2473423740632)               #changed group avd and sd
  #  da=((dz1-0.0638638733267406)/2.1427683118956535)
    
    b=((co2-1456.6391278541234)/1136.5534767844747)
   # db=((dz2-0.0638654702130458)/2.108189678851196)
    
    
    c=((co3-1457.0185787395235)/1139.6414395961863)
   # dc=((dz3-0.06386691438591093)/2.1175639313283745)
    
    
    d=((co4-1457.0723934194505)/1137.3779508854207)
  #  dd=((dz4-1456.0606374994725)/2.1196403497694223)
    
    
    e=((co5-1456.0606374994725)/1135.1186412360885)
   # de=((dz5-0.06387351647381606)/2.096588174371372)
    
    
    f=((co6-1457.220173709606)/1137.8027890096632)
    #df=((dz6-0.06388384196958394)/2.11233577808761)
   
    g=((temp-21.99985054933706)/0.0011882719873640968)
    h=((press-80.00001721478221)/0.00020207148656728872)
    i=((humid-0.08515214196256149)/0.06272724186119283)
    j=((pas-91.05336583796903)/61.95548201661293)                                                
    
    V_X=pd.DataFrame({'CO2_Zone_1':a,'dz1':dz1,'CO2_Zone_2':b,'CO2_Zone_3':c,'CO2_Zone_4':d,'CO2_Zone_5':e,'CO2_Zone_6':f,'temp_f':g,'press_f':h,'humid_f':i,'pass_f':j},index=[0])
    #V_X=pd.DataFrame({'CO2_Zone_1':a,'dz1':da,'CO2_Zone_2':b,'dz2':db,'CO2_Zone_3':c,'dz3':dc,'CO2_Zone_4':d,'dz4':dd,'CO2_Zone_5':e,'dz5':de,'CO2_Zone_6':f,'dz6':df,'temp_f':g,'press_f':h,'humid_f':i,'pass_f':j},index=[0])
   # V_X=pd.DataFrame({a,da,b,db,c,dc,d,dd,e,de,f,df,g,h,i,j})
 
    X_test = V_X.values
    y_pred = model.predict(X_test)
  
    y_pred_class = np.argmax(y_pred,axis=1)

    print(y_pred_class)

#    ans = y_pred_class[0]
    #ans = ans-1
  #  print("class",ans)
    

predict(855.6928945,0.00E+00,854.610339,855.5876456,855.1140273,855.1140271,856.1477167,22,80,0.058074,70)
predict(852.7624429,0,851.4769346,852.4768195,852.1535818,852.1536071,853.0971088,22,80,0.058074,70)
predict(929.7872431,0,928.2047187,929.4113141,929.009091,929.0692154,930.0270955,22,80,0.058074,70)
predict(352.001738,0,352.9066922,354.1902945,355.247421,354.1311484,357.5279227,22,80,0.04,93)
predict(1138.797016,1,1149.043175,1140.043684,1140.339404,1138.898064,1141.471035,22,80,0.077504,93)
predict(2438.904134,1,2438.76041,2439.488991,2472.918331,2437.611359,2439.998065,22,80,0.077504,93)
predict(1008.733312,1,1009.185481,1011.725907,1012.783569,1014.343207,1016.90226,22,80,0.058074,70)
predict(1109.678648,1,1110.21176,1113.065902,1114.579772,1116.414867,1119.20647,22,80,0.058074,70)
predict(1163.535359,-1,1161.983229,1162.536606,1161.827356,1161.449327,1161.958862,22,80,0.058074,70)
predict(941.3463566,-1,939.7509211,940.9446255,940.5295224,940.576782,941.5218136,22,80,0.058074,70)
predict(1283.28098,-1,1282.934635,1283.317869,1283.00972,1280.965144,1282.935649,22,80,0.077504,93)


predict(855.6928945,0,854.610339,855.5876456,855.1140273,855.1140271,856.1477167,22,80,0.058074,70)
predict(852.7624429,0,851.4769346,852.4768195,852.1535818,852.1536071,853.0971088,22,80,0.058074,70)
predict(929.7872431,0,928.2047187,929.4113141,929.009091,929.0692154,930.0270955,22,80,0.058074,70)
predict(352.001738,0,352.9066922,354.1902945,355.247421,354.1311484,357.5279227,22,80,0.04,93)
predict(1138.797016,1,1149.043175,1140.043684,1140.339404,1138.898064,1141.471035,22,80,0.077504,93)
predict(2438.904134,1,2438.76041,2439.488991,2472.918331,2437.611359,2439.998065,22,80,0.077504,93)
predict(1008.733312,1,1009.185481,1011.725907,1012.783569,1014.343207,1016.90226,22,80,0.058074,70)
predict(1109.678648,1,1110.21176,1113.065902,1114.579772,1116.414867,1119.20647,22,80,0.058074,70)
predict(1163.535359,-1,1161.983229,1162.536606,1161.827356,1161.449327,1161.958862,22,80,0.058074,70)
predict(941.3463566,-1,939.7509211,940.9446255,940.5295224,940.576782,941.5218136,22,80,0.058074,70)
predict(1283.28098,-1,1282.934635,1283.317869,1283.00972,1280.965144,1282.935649,22,80,0.077504,93)
predict(354.8594245,0,356.9091548,356.9277828,358.5009474,360.155302,361.5469461,22,80,0.11548,141)
predict(1426.37025,0,1426.76957,1425.793003,1425.899099,1426.591638,1426.484708,22,80,0.11548,141)
predict(1416.610534,0,1417.009022,1415.994033,1416.287262,1416.791009,1416.633128,22,80,0.11548,141)
predict(837.9056982,-1,838.9502299,838.9424906,837.7772323,838.3863665,838.1036072,22,80,0.03943,47)
predict(1044.624602,1,1046.03748,1046.510552,1045.750615,1046.802458,1047.218974,21.992,80.0013,0.28561,47)
predict(1682.639366,-1,1681.907558,1681.709926,1681.768272,1680.954771,1680.786975,22,80,0.11548,140)
predict(4016.704949,1,4016.836134,4081.788272,4016.869999,4016.52723,4016.563052,22,80,0.11548,140)
predict(1635.816775,1,1659.487902,1636.95486,1638.195431,1638.713299,1639.581147,22,80,0.11548,140)
predict(777.2060276,1,778.8189807,778.6647546,779.4346654,780.5799262,780.2537026,22,80,0.03943,47)
predict(882.266471,1,884.9768605,886.301884,888.669786,891.0506342,892.3581095,22,80,0.03943,47)
predict(1175.977252,-1,1176.840669,1175.670998,1175.370251,1175.618905,1174.177799,22,80,0.03943,47)



predict(350.6681712,0,351.7890373,353.95749,355.861014,357.5518624,359.6689584,22,80,0.15176,186)
predict(1778.35876,0,1778.433949,1778.35876,1778.471544,1778.396354,1778.333696,22,80,0.15176,186)
predict(1721.108556,0,1721.06288,1721.017212,1721.046742,1721.189065,1720.886528,22,80,0.15176,186)
predict(1780.543333,0,1780.469128,1780.545301,1780.433498,1780.509669,1780.573307,22,80,0.15176,186)
predict(1781.35248,0,1781.277371,1781.352641,1781.239937,1781.315208,1781.377946,22,80,0.15176,186)
predict(1367.726966,1,1368.807962,1368.144568,1368.932113,1369.433841,1368.986879,22.0001,79.9999,0.15348,93)
predict(1717.977137,1,1718.862702,1718.003877,1718.596191,1718.90278,1718.260727,22.0001,79.9999,0.15348,93)
predict(1390.051657,1,1391.255139,1391.014915,1392.112815,1392.6993,1392.706701,22.0015,79.9995,0.27324,93)
predict(2788.406344,1,2789.141846,2788.433445,2789.063654,2789.182478,2788.722233,22.0015,79.9995,0.27324,93)
predict(2844.029627,1,2844.788648,2844.073671,2844.757483,2844.839662,2844.362824,22.0015,79.9995,0.27324,93)
predict(2242.020736,1,2136.422793,2140.644687,2145.301205,2150.531419,2154.814521,22,80,0.15176,186)
predict(5226.430412,1,5312.466509,5226.284316,5226.285631,5225.986,5226.244376,22,80,0.15176,186)
predict(5204.417828,1,5204.756122,5204.567763,5290.51524,5204.869885,5204.612552,22,80,0.15176,186)
predict(5204.418479,1,5204.756772,5204.568413,5290.515889,5204.870533,5204.6132,22,80,0.15176,186)
predict(5771.5081,1,5771.837032,5873.876754,5771.804717,5772.103346,5771.955464,22,80,0.15176,186)
predict(1920.343208,1,1920.395411,1920.552278,1921.813858,1921.834174,1922.726111,22,80,0.13887,170)
predict(1955.29849,1,1956.10271,1956.499918,1957.768382,1958.532088,1959.19582,22,80,0.13887,170)
predict(1968.638363,1,1968.873123,1969.302709,1970.190296,1970.460633,1971.257899,22,80,0.13887,170)
predict(1996.847318,1,1996.8736,1996.839464,1997.316373,1997.37194,1997.572615,22,80,0.13887,170)
predict(1934.886206,1,1934.981689,1935.016676,1935.562627,1935.687162,1935.956728,22,80,0.13887,170)
predict(2014.984812,-1,2014.304628,2013.720744,2014.236778,2013.51009,2013.656392,22,80,0.13887,170)
predict(2428.74264,-1,2427.732394,2426.313218,2425.765827,2424.715665,2423.568282,22,80,0.13887,170)
predict(1933.710891,-1,1933.107162,1932.608831,1933.215947,1932.582527,1932.821459,22,80,0.13887,170)
predict(1948.664023,-1,1948.032946,1947.342185,1947.163198,1946.563606,1946.109852,22,80,0.13887,170)
predict(2098.777403,-1,2097.904328,2097.22732,2097.009559,2096.17577,2095.870153,22,80,0.13887,170)


print('aaaaaaaaaaaaaaaaaaaaaaaa')


predict(1337.300772,1,1337.385909,1339.559835,1340.25132,1341.445219,1343.639,22,80,0.058074,70)
predict(1344.613157,1,1344.690125,1346.855894,1347.53923,1348.724989,1350.910641,22,80,0.058074,70)
predict(1351.875051,1,1351.943908,1354.101577,1354.776819,1355.954494,1358.132073,22,80,0.058074,70)
predict(1359.086805,1,1359.147605,1361.29723,1361.964435,1363.134083,1365.303644,22,80,0.058074,70)
predict(1366.248763,1,1366.301563,1368.443199,1369.102422,1370.264098,1372.425697,22,80,0.058074,70)
predict(1373.361271,1,1373.406125,1375.539828,1376.191124,1377.344883,1379.498575,22,80,0.058074,70)
predict(1380.424668,1,1380.461633,1382.587456,1383.230881,1384.376777,1386.522617,22,80,0.058074,70)
predict(1387.439296,1,1387.468425,1389.586423,1390.222031,1391.360118,1393.49816,22,80,0.058074,70)
predict(1394.405489,1,1394.426836,1396.537065,1397.164909,1398.295242,1400.425539,22,80,0.058074,70)
predict(1401.323583,1,1401.337203,1403.439714,1404.059848,1405.182481,1407.305087,22,80,0.058074,70)
predict(1408.19391,1,1408.199855,1410.294703,1410.90718,1412.022165,1414.137133,22,80,0.058074,70)
predict(1415.0168,1,1415.015123,1417.10236,1417.707233,1418.814624,1420.922007,22,80,0.058074,70)
predict(1421.792579,1,1421.783333,1423.863013,1424.460335,1425.560183,1427.660033,22,80,0.058074,70)
predict(1428.521574,1,1428.504812,1430.576985,1431.166808,1432.259166,1434.351535,22,80,0.058074,70)
predict(1435.204108,1,1435.17988,1437.2446,1437.826975,1438.911894,1440.996835,22,80,0.058074,70)
predict(1441.8405,1,1441.808859,1443.866177,1444.441156,1445.518688,1447.59625,22,80,0.058074,70)
predict(1448.431071,1,1448.392068,1450.442033,1451.009668,1452.079863,1454.150099,22,80,0.058074,70)
predict(1454.976135,1,1454.929821,1456.972486,1457.532826,1458.595736,1460.658696,22,80,0.058074,70)
predict(1461.476008,1,1461.422433,1463.457848,1464.010944,1465.066619,1467.122353,22,80,0.058074,70)
predict(1467.931002,1,1467.870216,1469.898431,1470.444333,1471.492823,1473.54138,22,80,0.058074,70)
predict(1474.341426,1,1474.273479,1476.294543,1476.833301,1477.874655,1479.916086,22,80,0.058074,70)
predict(1480.707587,1,1480.632529,1482.646492,1483.178155,1484.212423,1486.246777,22,80,0.058074,70)
predict(1487.029793,1,1486.947673,1488.954583,1489.4792,1490.506431,1492.533756,22,80,0.058074,70)
predict(1493.308346,1,1493.219212,1495.219119,1495.736739,1496.75698,1498.777326,22,80,0.058074,70)
predict(1499.543547,1,1499.447448,1501.4404,1501.951071,1502.964372,1504.977786,22,80,0.058074,70)
predict(1505.735696,1,1505.63268,1507.618725,1508.122495,1509.128903,1511.135433,22,80,0.058074,70)
predict(1511.88509,1,1511.775205,1513.754391,1514.251308,1515.250871,1517.250564,22,80,0.058074,70)
predict(1517.992025,1,1517.875318,1519.847692,1520.337802,1521.330568,1523.323472,22,80,0.058074,70)
predict(1524.056793,1,1523.933311,1525.89892,1526.382272,1527.368286,1529.354448,22,80,0.058074,70)
predict(1530.079686,1,1529.949476,1531.908367,1532.385006,1533.364317,1535.343783,22,80,0.058074,70)
predict(1536.060993,1,1535.924101,1537.87632,1538.346294,1539.318946,1541.291763,22,80,0.058074,70)
predict(1542.001001,1,1541.857474,1543.803067,1544.26642,1545.232461,1547.198674,22,80,0.058074,70)
predict(1547.899994,1,1547.749878,1549.688891,1550.14567,1551.105144,1553.064799,22,80,0.058074,70)
predict(1553.758258,1,1553.601597,1555.534075,1555.984326,1556.937279,1558.890421,22,80,0.058074,70)
predict(1559.576071,1,1559.412912,1561.338901,1561.782668,1562.729144,1564.675819,22,80,0.058074,70)
